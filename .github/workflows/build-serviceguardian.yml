name: Build ServiceGuardian

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (ç•™ç©ºåˆ™è‡ªåŠ¨ä»æºä»£ç è¯»å–)'
        required: false
        default: ''

  # ä» ServiceGuardian ä»“åº“æ¥æ”¶ webhook è§¦å‘
  repository_dispatch:
    types: [serviceguardian-updated]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout ServiceGuardian source code
      uses: actions/checkout@v4
      with:
        repository: simtelboy/ServiceGuardian
        token: ${{ secrets.SERVICEGUARDIAN_TOKEN }}
        path: ServiceGuardian

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      working-directory: ServiceGuardian
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64

    - name: Build Release
      working-directory: ServiceGuardian/build
      run: cmake --build . --config Release

    - name: Get version from source code
      id: version
      run: |
        # ä» C++ æºä»£ç ä¸­æå–ç‰ˆæœ¬å·
        $sourceFile = "ServiceGuardian/ServiceGuardian.cpp"
        $content = Get-Content $sourceFile -Raw

        if ($content -match '#define\s+APP_VERSION\s+L"([^"]+)"') {
          $version = $matches[1]
          echo "âœ… ä»æºä»£ç ä¸­æå–åˆ°ç‰ˆæœ¬å·: $version"
        } else {
          echo "âš ï¸ æ— æ³•ä»æºä»£ç æå–ç‰ˆæœ¬å·ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬"
          $version = "1.0.0"
        }

        # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æŒ‡å®šäº†ç‰ˆæœ¬å·ï¼Œä½¿ç”¨æŒ‡å®šçš„ç‰ˆæœ¬å·
        if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
          echo "âœ… ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ç‰ˆæœ¬å·: $version"
        }

        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "ğŸ“¦ Release version: $version"

    - name: Prepare release files
      run: |
        mkdir release
        Copy-Item ServiceGuardian/build/bin/Release/ServiceGuardian.exe release/

        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        $version = "${{ steps.version.outputs.VERSION }}"
        $buildDate = Get-Date -Format "yyyy-MM-dd HH:mm:ss"

        # è·å– commit hashï¼ˆä¸æ”¹å˜å½“å‰ç›®å½•ï¼‰
        Push-Location ServiceGuardian
        $commitHash = git rev-parse --short HEAD
        Pop-Location

        @"
        ServiceGuardian v$version
        Build Date: $buildDate
        Commit: $commitHash

        AIæœåŠ¡å®ˆæŠ¤è¿›ç¨‹ - è‡ªåŠ¨ç¼–è¯‘ç‰ˆæœ¬
        "@ | Out-File -FilePath release/BUILD_INFO.txt -Encoding UTF8

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: ServiceGuardian v${{ steps.version.outputs.VERSION }}
        body: |
          ## ServiceGuardian v${{ steps.version.outputs.VERSION }}

          è‡ªåŠ¨ç¼–è¯‘çš„ ServiceGuardian å‘å¸ƒç‰ˆæœ¬

          ### ä¸‹è½½
          - [ServiceGuardian.exe](https://github.com/simtelboy/ai-toolkit/releases/download/v${{ steps.version.outputs.VERSION }}/ServiceGuardian.exe)

          ### å˜æ›´
          æ­¤ç‰ˆæœ¬ä» [ServiceGuardian](https://github.com/simtelboy/ServiceGuardian) ä»“åº“è‡ªåŠ¨ç¼–è¯‘ç”Ÿæˆã€‚

          æŸ¥çœ‹å®Œæ•´å˜æ›´æ—¥å¿—è¯·è®¿é—®æºä»£ç ä»“åº“ã€‚
        files: |
          release/ServiceGuardian.exe
          release/BUILD_INFO.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ServiceGuardian-v${{ steps.version.outputs.VERSION }}
        path: release/
